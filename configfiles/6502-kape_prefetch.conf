# SOF-ELKÂ® Configuration File
# Author: Phil Hagen
# Email: phil@lewestech.com
#
# (C)2019 Lewes Technology Consulting, LLC
#
# This conf file accepts logs from the KAPE forensic tool

filter {
  if [type] == "kape_prefetch" and "json" not in [tags] {
    mutate {
      # create two timestamp fields with the MACBs in subfields
      rename => {
        "[raw][SourceModified]" => "[origin][lastmodified]"
        "[raw][SourceAccessed]" => "[origin][lastaccess]"
        "[raw][SourceCreated]" => "[origin][created]"

        "[raw][LastRun]" => "[target][lastrun]"
        "[raw][PreviousRun0]" => "[target][previousrun0]"
        "[raw][PreviousRun1]" => "[target][previousrun1]"
        "[raw][PreviousRun2]" => "[target][previousrun2]"
        "[raw][PreviousRun3]" => "[target][previousrun3]"
        "[raw][PreviousRun4]" => "[target][previousrun4]"
        "[raw][PreviousRun5]" => "[target][previousrun5]"
        "[raw][PreviousRun6]" => "[target][previousrun6]"
      }
    }

    # convert all Source timestamps to date/time types
    date {
      match => [ "[origin][lastmodified]", "ISO8601" ]
      target => "[origin][lastmodified]"
    }
    date {
      match => [ "[origin][lastaccess]", "ISO8601" ]
      target => "[origin][lastaccess]"
    }
    date {
      match => [ "[origin][created]", "ISO8601" ]
      target => "[origin][created]"
    }

    # convert all target timestamps to date/time types
    date {
      match => [ "[target][lastrun]", "ISO8601" ]
      target => "[target][lastrun]"
    }
    date {
      match => [ "[target][previousrun0]", "ISO8601" ]
      target => "[target][previousrun0]"
    }
    date {
      match => [ "[target][previousrun1]", "ISO8601" ]
      target => "[target][previousrun1]"
    }
    date {
      match => [ "[target][previousrun2]", "ISO8601" ]
      target => "[target][previousrun2]"
    }
    date {
      match => [ "[target][previousrun3]", "ISO8601" ]
      target => "[target][previousrun3]"
    }
    date {
      match => [ "[target][previousrun4]", "ISO8601" ]
      target => "[target][previousrun4]"
    }
    date {
      match => [ "[target][previousrun5]", "ISO8601" ]
      target => "[target][previousrun5]"
    }
    date {
      match => [ "[target][previousrun6]", "ISO8601" ]
      target => "[target][previousrun6]"
    }


    # clean up by promoting needed fields to keep and removing [raw] placeholder
    mutate {
      rename => {
        "[raw][SourceFilename]" => "[origin][filename]"
        "[raw][ExecutableName]" => "[target][filename]"
### where should this land?        "[raw][Hash]" => "[hash]"
        "[raw][Size]" => "[target][filesize]"
        "[raw][Version]" => "[origin][version]"
### where should this land?        "[raw][RunCount]" => "[runcount]"
        "[raw][]" => "[]"
        "[raw][]" => "[]"
        "[raw][]" => "[]"
        "[raw][]" => "[]"
        "[raw][]" => "[]"


      }
      remove_field => [ "raw" ]
    }
  }
}
